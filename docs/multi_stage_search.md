# MultiStageSearch（多段階検索）ドキュメント

## 概要

MultiStageSearch（多段階検索）は、LazyRAG における **検索オーケストレーション機能** です。RAG の実行時に複数レベルの検索サーバーを組み合わせ、段階的に情報を収集・絞り込み・追加解析していく仕組みを提供します。

## 目的

1. **段階的な精度向上**  
   軽量サーバーで広く候補を集め、必要な場合のみ中・高コストサーバーに昇格させることで効率的に検索精度を高める。

2. **検索コストの最適化**  
   全てを最も高コストなサーバーで処理するのではなく、必要なドキュメントのみ昇格させることで計算資源を節約する。

3. **柔軟なワークフロー制御**  
   直列（A→B→C）だけでなく、並列や合流（{A,B}→C）のような DAG 構造を表現できる。  
   上流ノードの出力を **from_nodes** で指定することで、サーバーにドキュメントを追加（ensure）しつつ検索候補に絞ることができる。

## LazyRAG における用途

* **初期候補生成**  
  Raw/軽量サーバーで全文検索し、関連度の高い候補を抽出する。

* **特徴量付与・近傍探索**  
  抽出された候補を中間サーバーに追加（ensure）し、Embedding 検索などで再スコアリングする。

* **高次解析**  
  LLM 解析や構造化知識化を行う高コストサーバーに必要なドキュメントのみを追加し、より精緻な検索を行う。

* **合流と統合**  
  複数の検索経路を from_nodes 経由で統合サーバーに流し込み、最終的な検索結果を得る。

## 期待される効果

* 計算コストを抑えつつ高精度な検索を実現
* 検索パイプラインを宣言的に記述でき、再現性や可読性を向上
* 新たな検索サーバーを追加してもオーケストレーション層に統合しやすい
* 設定ファイル（`model_dump`/`load_from_config`）により、ワークフローの保存・再利用・配布が容易

## まとめ

MultiStageSearch（多段階検索）は、LazyRAG の中核となる検索制御機構であり、**効率性と柔軟性を両立した検索基盤**を提供します。これにより、RAG システムは段階的に候補を精査し、最小限の計算資源で最大限の情報価値を得ることが可能となります。
